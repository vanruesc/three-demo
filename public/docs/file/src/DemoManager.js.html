<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/DemoManager.js | three-demo</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="A demo scaffold for three.js."><meta property="twitter:card" content="summary"><meta property="twitter:title" content="three-demo"><meta property="twitter:description" content="A demo scaffold for three.js."></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/vanruesc/three-demo.git"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Demo.js~Demo.html">Demo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/DemoManager.js~DemoManager.html">DemoManager</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-change">change</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-load">load</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/DemoManager.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import { EffectComposer } from &quot;postprocessing&quot;;
import { EventTarget } from &quot;synthetic-event&quot;;
import { Clock, WebGLRenderer } from &quot;three&quot;;
import dat from &quot;dat.gui&quot;;
import Stats from &quot;stats.js&quot;;

import * as events from &quot;./demo-manager-events.js&quot;;

/**
 * The initial URL hash value.
 *
 * @type {String}
 * @private
 */

const initialHash = window.location.hash.slice(1);

/**
 * A demo manager.
 */

export class DemoManager extends EventTarget {

	/**
	 * Constructs a new demo manager.
	 *
	 * @param {HTMLElement} viewport - The primary DOM container.
	 * @param {Object} [options] - Additional options.
	 * @param {HTMLElement} [options.aside] - A secondary DOM container.
	 * @param {EffectComposer} [options.composer] - A custom effect composer.
	 */

	constructor(viewport, options = {}) {

		const aside = (options.aside !== undefined) ? options.aside : viewport;

		super();

		/**
		 * A composer.
		 *
		 * @type {EffectComposer}
		 */

		this.composer = (options.composer !== undefined) ? options.composer : (() =&gt; {

			const renderer = new WebGLRenderer();
			renderer.setSize(viewport.clientWidth, viewport.clientHeight);
			renderer.setPixelRatio(window.devicePixelRatio);

			return new EffectComposer(renderer);

		})();

		/**
		 * The main renderer.
		 *
		 * @type {WebGLRenderer}
		 * @private
		 */

		this.renderer = this.composer.renderer;

		viewport.appendChild(this.renderer.domElement);

		/**
		 * A clock.
		 *
		 * @type {Clock}
		 * @private
		 */

		this.clock = new Clock();

		/**
		 * A menu for custom demo options.
		 *
		 * @type {GUI}
		 * @private
		 */

		this.menu = new dat.GUI({ autoPlace: false });

		aside.appendChild(this.menu.domElement);

		/**
		 * Performance statistics.
		 *
		 * @type {Stats}
		 * @private
		 */

		this.statistics = new Stats();
		this.statistics.dom.id = &quot;statistics&quot;;

		aside.appendChild(this.statistics.domElement);

		/**
		 * A collection of demos.
		 *
		 * @type {Map}
		 * @private
		 */

		this.demos = new Map();

		/**
		 * The id of the current demo.
		 *
		 * @type {String}
		 * @private
		 */

		this.demo = null;

		/**
		 * The current demo.
		 *
		 * @type {Demo}
		 * @private
		 */

		this.currentDemo = null;

	}

	/**
	 * Updates the demo options menu.
	 *
	 * @private
	 * @todo Use a menu library that is not as clunky as dat.GUI.
	 * @return {GUI} The cleaned menu.
	 */

	resetMenu() {

		const node = this.menu.domElement.parentNode;
		const menu = new dat.GUI({ autoPlace: false });
		const selection = menu.add(this, &quot;demo&quot;, Array.from(this.demos.keys()));
		selection.onChange(() =&gt; this.loadDemo());

		node.removeChild(this.menu.domElement);
		node.appendChild(menu.domElement);

		this.menu.destroy();
		this.menu = menu;

		return menu;

	}

	/**
	 * Activates the given demo if it&apos;s still selected.
	 *
	 * While the demo was loading, another demo may have been selected already.
	 *
	 * @private
	 * @param {Demo} demo - A demo that just finished loading.
	 */

	startDemo(demo) {

		if(demo.id === this.demo) {

			demo.initialize();
			demo.registerOptions(this.resetMenu());
			demo.ready = true;

			this.dispatchEvent(events.load);

		}

	}

	/**
	 * Loads the currently selected demo.
	 *
	 * @private
	 */

	loadDemo() {

		const id = this.demo;
		const demos = this.demos;
		const demo = demos.get(id);
		const previousDemo = this.currentDemo;

		const composer = this.composer;
		const renderer = this.renderer;

		let size;

		// Update the URL.
		window.location.hash = id;

		if(previousDemo !== null) {

			previousDemo.reset();

			// Update and use the main renderer.
			size = composer.renderer.getSize();
			renderer.setSize(size.width, size.height);
			composer.replaceRenderer(renderer);

		}

		this.menu.domElement.style.display = &quot;none&quot;;

		// Clear the screen and remove all passes.
		renderer.clear();
		composer.reset();
		composer.addPass(demo.renderPass);

		this.currentDemo = demo;
		this.dispatchEvent(events.change);

		demo.load().then(() =&gt; this.startDemo(demo))
			.catch((e) =&gt; console.error(e));

	}

	/**
	 * Adds a demo.
	 *
	 * @param {Demo} demo - The demo.
	 * @return {DemoManager} This manager.
	 */

	addDemo(demo) {

		this.demos.set(demo.id, demo.setComposer(this.composer));

		if(this.demo === null || demo.id === initialHash) {

			this.demo = demo.id;
			this.loadDemo();

		}

		return this;

	}

	/**
	 * Removes a demo.
	 *
	 * @param {String} id - The id of the demo.
	 * @return {DemoManager} This manager.
	 */

	removeDemo(id) {

		const demos = this.demos;

		let firstEntry;

		if(demos.has(id)) {

			demos.delete(id);

			if(this.demo === id &amp;&amp; demos.size &gt; 0) {

				// Load the first of the remaining demos.
				firstEntry = demos.entries().next().value;
				this.demo = firstEntry[0];
				this.currentDemo = firstEntry[1];
				this.loadDemo();

			} else {

				this.demo = null;
				this.currentDemo = null;
				this.renderer.clear();
				this.composer.reset();

			}

		}

		return this;

	}

	/**
	 * Sets the render size.
	 *
	 * @param {Number} width - The width.
	 * @param {Number} height - The height.
	 */

	setSize(width, height) {

		const demo = this.currentDemo;

		this.composer.setSize(width, height);

		if(demo !== null &amp;&amp; demo.camera !== null) {

			demo.camera.aspect = width / height;
			demo.camera.updateProjectionMatrix();

		}

	}

	/**
	 * The main render loop.
	 *
	 * @param {DOMHighResTimeStamp} now - The current time.
	 */

	render(now) {

		const demo = this.currentDemo;
		const delta = this.clock.getDelta();

		if(demo !== null &amp;&amp; demo.ready) {

			this.statistics.begin();

			demo.update(delta);
			this.composer.render(delta);

			this.statistics.end();

		}

	}

}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
